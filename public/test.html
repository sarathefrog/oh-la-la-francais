<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .test-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2d3748;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .result {
            background: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .error {
            background: #fed7d7;
            border: 1px solid #f56565;
            color: #742a2a;
        }

        .success {
            background: #c6f6d5;
            border: 1px solid #48bb78;
            color: #22543d;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§Ø³</h1>

        <div class="test-section">
            <h3>ğŸ“… Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³</h3>
            <div class="form-group">
                <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</label>
                <select id="studentSelect">
                    <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³:</label>
                <select id="classSelect">
                    <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="sendClassReminder()">Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³</button>
            <div id="reminderResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</h3>
            <div class="form-group">
                <label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³ (Ø§Ø² Ù„ÛŒØ³Øª Ø¨Ø§Ù„Ø§):</label>
                <select id="reviewClassSelect">
                    <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="sendClassReview()">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</button>
            <button class="btn btn-warning" onclick="sendReviewToStudent()">Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
            <div id="reviewResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>â° ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Ú©Ø§Ø±</h3>
            <p>Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:</p>
            <ul>
                <li>5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ú©Ù„Ø§Ø³: Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</li>
                <li>1.5 Ø³Ø§Ø¹Øª Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ù„Ø§Ø³: Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</li>
            </ul>
            <button class="btn btn-warning" onclick="checkReminders()">Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</button>
            <div id="checkResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§</h3>
            <button class="btn btn-primary" onclick="loadClasses()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§</button>
            <div id="classesList" class="result"></div>
        </div>
    </div>

    <script>
        let students = [];
        let classes = [];

        // Load students on page load
        document.addEventListener('DOMContentLoaded', loadStudents);

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();
                students = data.students.filter(s => s.registrationStatus === 'approved');
                
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.telegramId})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading students:', error);
                showResult('reminderResult', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†', 'error');
            }
        }

        // Load classes for selected student
        async function loadClassesForStudent(studentId) {
            try {
                const response = await fetch(`/api/students/${studentId}/classes`);
                classes = await response.json();
                
                const classSelect = document.getElementById('classSelect');
                const reviewClassSelect = document.getElementById('reviewClassSelect');
                
                classSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³</option>';
                reviewClassSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³</option>';
                
                classes.forEach(classRecord => {
                    const date = new Date(classRecord.date);
                    const dateStr = date.toLocaleDateString('fa-IR');
                    const timeStr = date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
                    
                    const option1 = document.createElement('option');
                    option1.value = classRecord.id;
                    option1.textContent = `${classRecord.day} - ${classRecord.time} (${dateStr})`;
                    classSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = classRecord.id;
                    option2.textContent = `${classRecord.day} - ${classRecord.time} (${dateStr})`;
                    reviewClassSelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
                showResult('reminderResult', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§', 'error');
            }
        }

        // Send class reminder
        async function sendClassReminder() {
            const classId = document.getElementById('classSelect').value;
            if (!classId) {
                showResult('reminderResult', 'Ù„Ø·ÙØ§Ù‹ Ú©Ù„Ø§Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/test/send-reminder/${classId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showResult('reminderResult', 'ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!', 'success');
                } else {
                    throw new Error('Failed to send reminder');
                }
            } catch (error) {
                console.error('Error sending reminder:', error);
                showResult('reminderResult', 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ', 'error');
            }
        }

        // Send class review
        async function sendClassReview() {
            const classId = document.getElementById('reviewClassSelect').value;
            if (!classId) {
                showResult('reviewResult', 'Ù„Ø·ÙØ§Ù‹ Ú©Ù„Ø§Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/test/send-review/${classId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showResult('reviewResult', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!', 'success');
                } else {
                    throw new Error('Failed to send review');
                }
            } catch (error) {
                console.error('Error sending review:', error);
                showResult('reviewResult', 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ', 'error');
            }
        }

        // Check reminders manually
        async function checkReminders() {
            try {
                const response = await fetch('/api/test/check-reminders', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('checkResult', `Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. ${result.remindersSent} ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ùˆ ${result.reviewsSent} Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.`, 'success');
                } else {
                    throw new Error('Failed to check reminders');
                }
            } catch (error) {
                console.error('Error checking reminders:', error);
                showResult('checkResult', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§', 'error');
            }
        }

        // Load all classes
        async function loadClasses() {
            try {
                const response = await fetch('/api/classes');
                const allClasses = await response.json();
                
                let html = '<h4>Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡:</h4><ul>';
                allClasses.forEach(classRecord => {
                    const date = new Date(classRecord.date);
                    const dateStr = date.toLocaleDateString('fa-IR');
                    const timeStr = date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `<li>${classRecord.student.name} - ${classRecord.day} ${classRecord.time} (${dateStr}) - ${classRecord.status}</li>`;
                });
                html += '</ul>';
                
                showResult('classesList', html, 'success');
            } catch (error) {
                console.error('Error loading classes:', error);
                showResult('classesList', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§', 'error');
            }
        }

        // Show result
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // Send review to student
        async function sendReviewToStudent() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                showResult('reviewResult', 'Ù„Ø·ÙØ§Ù‹ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/test/send-review-to-student/${studentId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showResult('reviewResult', 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!', 'success');
                } else {
                    throw new Error('Failed to send review');
                }
            } catch (error) {
                console.error('Error sending review to student:', error);
                showResult('reviewResult', 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ', 'error');
            }
        }

        // Student selection change
        document.getElementById('studentSelect').addEventListener('change', function() {
            const studentId = this.value;
            if (studentId) {
                loadClassesForStudent(studentId);
            }
        });
    </script>
</body>
</html>
